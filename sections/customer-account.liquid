{% comment %}
  Customer Account Section
{% endcomment %}

{%- liquid
  assign show_quote_history = section.settings.show_quote_history
  assign show_email_preferences = section.settings.show_email_preferences
  assign active_tab = 'orders'
  if request.path contains 'quotes'
    assign active_tab = 'quotes'
  elsif request.path contains 'preferences'
    assign active_tab = 'preferences'
  endif
-%}

<section class="customer-account section">
  <div class="container">
    <header class="customer-account__header">
      <h1 class="customer-account__title h2">{{ 'customer.account.title' | t }}</h1>
      <p class="customer-account__welcome">
        {{ 'customer.account.welcome' | t: name: customer.first_name | default: customer.email }}
      </p>
    </header>
    
    <div class="customer-account__grid">
      {%- comment -%} Account Navigation {%- endcomment -%}
      <aside class="customer-account__sidebar">
        <nav class="customer-account__nav" aria-label="{{ 'customer.account.navigation' | t }}">
          <a href="{{ routes.account_url }}" class="customer-account__nav-link{% if active_tab == 'orders' %} is-active{% endif %}" data-tab-trigger="orders">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
              <line x1="3" y1="6" x2="21" y2="6"/>
              <path d="M16 10a4 4 0 0 1-8 0"/>
            </svg>
            {{ 'customer.account.orders' | t }}
          </a>
          
          {%- if show_quote_history -%}
            <a href="#quotes" class="customer-account__nav-link{% if active_tab == 'quotes' %} is-active{% endif %}" data-tab-trigger="quotes">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
              </svg>
              {{ 'customer.account.quotes' | t | default: 'Quote Requests' }}
            </a>
          {%- endif -%}
          
          {%- if show_email_preferences -%}
            <a href="#preferences" class="customer-account__nav-link{% if active_tab == 'preferences' %} is-active{% endif %}" data-tab-trigger="preferences">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                <polyline points="22,6 12,13 2,6"/>
              </svg>
              {{ 'customer.account.email_preferences' | t | default: 'Email Preferences' }}
            </a>
          {%- endif -%}
          
          <a href="{{ routes.account_addresses_url }}" class="customer-account__nav-link">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
              <circle cx="12" cy="10" r="3"/>
            </svg>
            {{ 'customer.account.addresses' | t }}
          </a>
          
          <a href="{{ routes.account_logout_url }}" class="customer-account__nav-link">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
              <polyline points="16 17 21 12 16 7"/>
              <line x1="21" y1="12" x2="9" y2="12"/>
            </svg>
            {{ 'customer.account.logout' | t }}
          </a>
        </nav>
        
        {%- comment -%} Account Info {%- endcomment -%}
        <div class="customer-account__info">
          <h3 class="customer-account__info-title h6">{{ 'customer.account.account_details' | t | default: 'Account Details' }}</h3>
          <p class="customer-account__info-email">{{ customer.email }}</p>
          {%- if customer.default_address -%}
            <address class="customer-account__info-address">
              {{ customer.default_address | format_address }}
            </address>
          {%- endif -%}
        </div>
      </aside>
      
      {%- comment -%} Content Area {%- endcomment -%}
      <div class="customer-account__content">
        {%- comment -%} Orders Tab {%- endcomment -%}
        <div class="customer-account__tab{% if active_tab == 'orders' %} is-active{% endif %}" data-tab="orders">
          <h2 class="customer-account__section-title h4">{{ 'customer.orders.title' | t }}</h2>
        
        {%- if customer.orders.size > 0 -%}
          <div class="customer-orders">
            <table class="customer-orders__table">
              <thead>
                <tr>
                  <th>{{ 'customer.orders.order_number' | t }}</th>
                  <th>{{ 'customer.orders.date' | t }}</th>
                  <th>{{ 'customer.orders.payment_status' | t }}</th>
                  <th>{{ 'customer.orders.fulfillment_status' | t }}</th>
                  <th>{{ 'customer.orders.total' | t }}</th>
                </tr>
              </thead>
              <tbody>
                {%- for order in customer.orders -%}
                  <tr>
                    <td data-label="{{ 'customer.orders.order_number' | t }}">
                      <a href="{{ order.customer_url }}" class="customer-orders__link">
                        {{ order.name }}
                      </a>
                    </td>
                    <td data-label="{{ 'customer.orders.date' | t }}">
                      {{ order.created_at | date: format: 'abbreviated_date' }}
                    </td>
                    <td data-label="{{ 'customer.orders.payment_status' | t }}">
                      <span class="customer-orders__badge customer-orders__badge--{{ order.financial_status }}">
                        {{ order.financial_status_label }}
                      </span>
                    </td>
                    <td data-label="{{ 'customer.orders.fulfillment_status' | t }}">
                      <span class="customer-orders__badge customer-orders__badge--{{ order.fulfillment_status | default: 'unfulfilled' }}">
                        {{ order.fulfillment_status_label | default: 'Unfulfilled' }}
                      </span>
                    </td>
                    <td data-label="{{ 'customer.orders.total' | t }}">
                      {{ order.total_price | money }}
                    </td>
                  </tr>
                {%- endfor -%}
              </tbody>
            </table>
            
            {%- if paginate.pages > 1 -%}
              {% render 'pagination', paginate: paginate %}
            {%- endif -%}
          </div>
        {%- else -%}
          <div class="customer-account__empty">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
              <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
              <line x1="3" y1="6" x2="21" y2="6"/>
              <path d="M16 10a4 4 0 0 1-8 0"/>
            </svg>
            <p>{{ 'customer.orders.none' | t }}</p>
            <a href="{{ routes.all_products_collection_url }}" class="button button--primary">
              {{ 'customer.orders.start_shopping' | t }}
            </a>
          </div>
        {%- endif -%}
        </div>
        
        {%- comment -%} Quote History Tab {%- endcomment -%}
        {%- if show_quote_history -%}
          <div class="customer-account__tab{% if active_tab == 'quotes' %} is-active{% endif %}" data-tab="quotes">
            {% render 'quote-history' %}
          </div>
        {%- endif -%}
        
        {%- comment -%} Email Preferences Tab {%- endcomment -%}
        {%- if show_email_preferences -%}
          <div class="customer-account__tab{% if active_tab == 'preferences' %} is-active{% endif %}" data-tab="preferences">
            {% render 'email-preferences' %}
          </div>
        {%- endif -%}
      </div>
    </div>
  </div>
</section>

<script>
  (function() {
    const tabs = document.querySelectorAll('[data-tab]');
    const triggers = document.querySelectorAll('[data-tab-trigger]');
    
    triggers.forEach(trigger => {
      trigger.addEventListener('click', (e) => {
        const targetTab = trigger.dataset.tabTrigger;
        
        // If it's a hash link, prevent default and handle manually
        if (trigger.getAttribute('href').startsWith('#')) {
          e.preventDefault();
          
          // Update active states
          triggers.forEach(t => t.classList.remove('is-active'));
          trigger.classList.add('is-active');
          
          tabs.forEach(tab => {
            tab.classList.toggle('is-active', tab.dataset.tab === targetTab);
          });
          
          // Update URL hash
          history.pushState(null, '', `#${targetTab}`);
        }
      });
    });
    
    // Handle initial hash
    if (window.location.hash) {
      const hash = window.location.hash.substring(1);
      const trigger = document.querySelector(`[data-tab-trigger="${hash}"]`);
      if (trigger) trigger.click();
    }
  })();
</script>

{% schema %}
{
  "name": "Customer Account",
  "tag": "section",
  "class": "customer-account-section",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_quote_history",
      "label": "Show quote history tab",
      "default": true,
      "info": "Display quote request history for B2B customers"
    },
    {
      "type": "checkbox",
      "id": "show_email_preferences",
      "label": "Show email preferences tab",
      "default": true,
      "info": "Allow customers to manage email subscriptions"
    }
  ]
}
{% endschema %}
